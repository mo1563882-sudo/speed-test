<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technovia Speed Test</title>

<style>
:root { --blue:#007bff; --dark:#222; }
body{
    background:#f0f2f5;font-family:tahoma;
    display:flex;justify-content:center;align-items:center;
    min-height:100vh;margin:0
}
.speedtest-card{
    background:#fff;width:95%;max-width:460px;
    padding:30px;border-radius:22px;
    box-shadow:0 15px 35px rgba(0,0,0,.1);
    text-align:center
}
.logo-title{color:var(--blue);font-size:24px;font-weight:800}
.subtitle{color:#666;margin-bottom:25px}
.gauge{
    width:180px;height:180px;margin:0 auto 20px;
    border:10px solid #f1f1f1;border-top:10px solid var(--blue);
    border-radius:50%;display:flex;flex-direction:column;
    justify-content:center;align-items:center
}
#main-speed{font-size:48px;font-weight:900;color:var(--dark)}
.mbps{color:var(--blue);font-weight:700}
.grid{
    display:grid;grid-template-columns:1fr 1fr 1fr;
    gap:15px;margin-top:20px;padding-top:15px;
    border-top:2px solid #eee
}
.lbl{font-size:12px;color:#777}
.val{font-weight:700;color:var(--blue)}
.extra{
    margin-top:15px;font-size:13px;color:#444;line-height:1.7
}
button{
    width:100%;padding:15px;margin-top:18px;
    background:var(--blue);color:#fff;border:0;
    border-radius:12px;font-size:18px;font-weight:700;
    cursor:pointer
}
button:disabled{background:#bbb}
</style>
</head>

<body>
<div class="speedtest-card">
    <div class="logo-title">Technovia Speed Test</div>
    <div class="subtitle">اختبار سرعة الإنترنت الذكي</div>

    <div class="gauge">
        <div id="main-speed">0</div>
        <div class="mbps">Mbps</div>
    </div>

    <button id="btn">بدء الاختبار | Start Test</button>

    <div class="grid">
        <div>
            <div class="lbl">متوسط التحميل<br>Average</div>
            <div class="val" id="avg">-</div>
        </div>
        <div>
            <div class="lbl">Ping</div>
            <div class="val" id="ping">-</div>
        </div>
        <div>
            <div class="lbl">Jitter</div>
            <div class="val" id="jitter">-</div>
        </div>
    </div>

    <div class="extra" id="details"></div>
</div>

<script>
const btn = document.getElementById("btn");
const main = document.getElementById("main-speed");
const avgEl = document.getElementById("avg");
const pingEl = document.getElementById("ping");
const jitterEl = document.getElementById("jitter");
const details = document.getElementById("details");

const MIRRORS = {
    small: ["https://speed.cloudflare.com/__down?bytes=3000000","pass.mp3"],
    medium:["https://speed.cloudflare.com/__down?bytes=20000000","https://proof.ovh.net/files/20Mb.dat"],
    large:["https://speed.cloudflare.com/__down?bytes=50000000","https://proof.ovh.net/files/50Mb.dat"]
};

async function getWorking(urls){
    for(const u of urls){
        try{
            const r=await fetch(u,{method:"HEAD",cache:"no-store"});
            if(r.ok) return u;
        }catch(e){}
    }
    throw "NO_SOURCE";
}

async function measurePing(){
    let t=[];
    for(let i=0;i<5;i++){
        const s=performance.now();
        await fetch("https://speed.cloudflare.com/__down?bytes=1",{cache:"no-store"});
        t.push(performance.now()-s);
    }
    const avg=t.reduce((a,b)=>a+b)/t.length;
    const jit=Math.sqrt(t.map(x=>(x-avg)**2).reduce((a,b)=>a+b)/t.length);
    return {ping:Math.round(avg),jitter:jit.toFixed(2)};
}

async function runTest(url){
    const res=await fetch(url+"?r="+Math.random(),{cache:"no-store"});
    const reader=res.body.getReader();

    const start=performance.now();
    let validStart=null,bytes=0;
    let samples=[];

    while(true){
        const {done,value}=await reader.read();
        if(done) break;

        const now=performance.now();
        if(now-start<2000) continue;

        if(!validStart) validStart=now;
        const elapsed=(now-validStart)/1000;
        if(elapsed<0.3) continue;

        bytes+=value.length;
        const mbps=((bytes*8)/(1024*1024))/elapsed;

        if(mbps>0 && mbps<10000){
            main.innerText=mbps.toFixed(1);
            samples.push(mbps);
        }
        if(now-start>15000) break;
    }

    if(samples.length<5) throw "BAD_DATA";
    return samples;
}

function stabilityLabel(noise,avg){
    const r=noise/avg;
    if(r<0.05) return "مستقرة جداً | Very Stable";
    if(r<0.10) return "مستقرة | Stable";
    if(r<0.20) return "متذبذبة | Unstable";
    return "غير مستقرة | Very Unstable";
}

btn.onclick=async()=>{
    btn.disabled=true;
    btn.innerText="جاري القياس...";
    main.innerText="0";
    avgEl.innerText=pingEl.innerText=jitterEl.innerText="-";
    details.innerText="";

    try{
        const pj=await measurePing();
        pingEl.innerText=pj.ping+" ms";
        jitterEl.innerText=pj.jitter+" ms";

        const preUrl=await getWorking(MIRRORS.small);
        const pre=await runTest(preUrl);
        const preAvg=pre.reduce((a,b)=>a+b)/pre.length;

        const group=preAvg<10?MIRRORS.small:preAvg<40?MIRRORS.medium:MIRRORS.large;
        const finalUrl=await getWorking(group);
        const s=await runTest(finalUrl);

        const avg=s.reduce((a,b)=>a+b)/s.length;
        const max=Math.max(...s);
        const min=Math.min(...s);
        const noise=Math.sqrt(s.map(x=>(x-avg)**2).reduce((a,b)=>a+b)/s.length);

        avgEl.innerText=avg.toFixed(1)+" Mbps";
        details.innerHTML=
        `
        أعلى سرعة | Max: <b>${max.toFixed(1)} Mbps</b><br>
        أدنى سرعة | Min: <b>${min.toFixed(1)} Mbps</b><br>
        التذبذب | Fluctuation: <b>${(max-min).toFixed(1)} Mbps</b><br>
        التشويش | Noise: <b>${noise.toFixed(2)}</b><br>
        حالة الاستقرار | Stability: <b>${stabilityLabel(noise,avg)}</b>
        `;

        btn.innerText="إعادة الاختبار";
        btn.disabled=false;

    }catch(e){
        alert("فشل الاختبار – تحقق من الاتصال");
        btn.disabled=false;
        btn.innerText="إعادة المحاولة";
    }
};
</script>
</body>
</html>
